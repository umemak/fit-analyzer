function I(){return crypto.randomUUID()}function f(){let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function R(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function y(e,t){if(!e)return null;let i=e.split(";");for(let o of i){let[s,c]=o.trim().split("=");if(s===t)return c}return null}var E=async e=>{let t=new URL(e.request.url),i=t.searchParams.get("code"),o=t.searchParams.get("state"),s=e.env.APP_URL||t.origin;if(!i){let a=R(),n=`${s}/api/auth/github`,d=`https://github.com/login/oauth/authorize?client_id=${e.env.GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(n)}&scope=user:email&state=${a}`;return new Response(null,{status:302,headers:{Location:d,"Set-Cookie":`oauth_state=${a}; Path=/; HttpOnly; SameSite=Lax; Max-Age=600${t.protocol==="https:"?"; Secure":""}`}})}let c=y(e.request.headers.get("Cookie"),"oauth_state");if(!o||o!==c)return Response.redirect(`${s}/?error=invalid_state`,302);try{let n=await(await fetch("https://github.com/login/oauth/access_token",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({client_id:e.env.GITHUB_CLIENT_ID,client_secret:e.env.GITHUB_CLIENT_SECRET,code:i})})).json();if(n.error||!n.access_token)return Response.redirect(`${s}/?error=auth_failed`,302);let r=await(await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${n.access_token}`,"User-Agent":"FIT-Analyzer"}})).json(),u=r.email;u||(u=(await(await fetch("https://api.github.com/user/emails",{headers:{Authorization:`Bearer ${n.access_token}`,"User-Agent":"FIT-Analyzer"}})).json()).find(S=>S.primary)?.email||`${r.id}@github.local`);let l=await e.env.DB.prepare("SELECT * FROM users WHERE provider = ? AND provider_id = ?").bind("github",String(r.id)).first();if(!l){let p=I();await e.env.DB.prepare("INSERT INTO users (id, email, name, avatar_url, provider, provider_id) VALUES (?, ?, ?, ?, ?, ?)").bind(p,u,r.name||r.login,r.avatar_url,"github",String(r.id)).run(),l={id:p,email:u,name:r.name||r.login,avatar_url:r.avatar_url}}let g=f(),m=new Date(Date.now()+720*60*60*1e3).toISOString();await e.env.DB.prepare("INSERT INTO sessions (id, user_id, expires_at) VALUES (?, ?, ?)").bind(g,l.id,m).run();let _=Response.redirect(`${s}/`,302),h=new Headers(_.headers);return h.set("Set-Cookie",`session=${g}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${720*60*60}${t.protocol==="https:"?"; Secure":""}`),new Response(null,{status:302,headers:h})}catch(a){return console.error("GitHub OAuth error:",a),Response.redirect(`${s}/?error=auth_failed`,302)}};export{E as onRequestGet};
