function u(){let s=new Uint8Array(32);return crypto.getRandomValues(s),Array.from(s,t=>t.toString(16).padStart(2,"0")).join("")}async function l(s,t){let[r,n]=t.split(":");if(!r||!n)return!1;let i=new Uint8Array(r.match(/.{2}/g).map(a=>parseInt(a,16))),e=new TextEncoder,c=await crypto.subtle.importKey("raw",e.encode(s),"PBKDF2",!1,["deriveBits"]),o=await crypto.subtle.deriveBits({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},c,256),p=new Uint8Array(o);return Array.from(p,a=>a.toString(16).padStart(2,"0")).join("")===n}var y=async s=>{let t=new URL(s.request.url);try{let r=await s.request.json(),{email:n,password:i}=r;if(!n||!i)return new Response(JSON.stringify({error:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3068\u30D1\u30B9\u30EF\u30FC\u30C9\u306F\u5FC5\u9808\u3067\u3059"}),{status:400,headers:{"Content-Type":"application/json"}});let e=await s.env.DB.prepare(`SELECT id, email, name, avatar_url, password_hash, provider 
       FROM users WHERE email = ? AND provider = 'email'`).bind(n).first();if(!e||!e.password_hash)return new Response(JSON.stringify({error:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u307E\u305F\u306F\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093"}),{status:401,headers:{"Content-Type":"application/json"}});if(!await l(i,e.password_hash))return new Response(JSON.stringify({error:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u307E\u305F\u306F\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093"}),{status:401,headers:{"Content-Type":"application/json"}});let o=u(),p=new Date(Date.now()+720*60*60*1e3).toISOString();await s.env.DB.prepare("INSERT INTO sessions (id, user_id, expires_at) VALUES (?, ?, ?)").bind(o,e.id,p).run();let d=t.protocol==="https:",a=`Path=/; HttpOnly; SameSite=Lax; Max-Age=${720*60*60}${d?"; Secure":""}`;return new Response(JSON.stringify({success:!0,user:{id:e.id,email:e.email,name:e.name,avatar_url:e.avatar_url,provider:"email"}}),{status:200,headers:{"Content-Type":"application/json","Set-Cookie":`session=${o}; ${a}`}})}catch(r){return console.error("Login error:",r),new Response(JSON.stringify({error:"\u30ED\u30B0\u30A4\u30F3\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}};export{y as onRequestPost};
