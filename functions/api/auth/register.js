function S(){return crypto.randomUUID()}function m(){let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,s=>s.toString(16).padStart(2,"0")).join("")}async function h(e){let s=new TextEncoder,i=crypto.getRandomValues(new Uint8Array(16)),t=Array.from(i,a=>a.toString(16).padStart(2,"0")).join(""),r=await crypto.subtle.importKey("raw",s.encode(e),"PBKDF2",!1,["deriveBits"]),n=await crypto.subtle.deriveBits({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},r,256),o=new Uint8Array(n),c=Array.from(o,a=>a.toString(16).padStart(2,"0")).join("");return`${t}:${c}`}var f=async e=>{let s=new URL(e.request.url),i=e.env.APP_URL||s.origin;try{let t=await e.request.json(),{email:r,password:n,name:o}=t;if(!r||!n)return new Response(JSON.stringify({error:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3068\u30D1\u30B9\u30EF\u30FC\u30C9\u306F\u5FC5\u9808\u3067\u3059"}),{status:400,headers:{"Content-Type":"application/json"}});if(n.length<8)return new Response(JSON.stringify({error:"\u30D1\u30B9\u30EF\u30FC\u30C9\u306F8\u6587\u5B57\u4EE5\u4E0A\u5FC5\u8981\u3067\u3059"}),{status:400,headers:{"Content-Type":"application/json"}});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))return new Response(JSON.stringify({error:"\u6709\u52B9\u306A\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044"}),{status:400,headers:{"Content-Type":"application/json"}});if(await e.env.DB.prepare("SELECT id FROM users WHERE email = ?").bind(r).first())return new Response(JSON.stringify({error:"\u3053\u306E\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u306F\u65E2\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u307E\u3059"}),{status:409,headers:{"Content-Type":"application/json"}});let p=S(),l=await h(n),d=o||r.split("@")[0];await e.env.DB.prepare(`INSERT INTO users (id, email, name, password_hash, provider, provider_id)
       VALUES (?, ?, ?, ?, 'email', ?)`).bind(p,r,d,l,r).run();let u=m(),y=new Date(Date.now()+720*60*60*1e3).toISOString();await e.env.DB.prepare("INSERT INTO sessions (id, user_id, expires_at) VALUES (?, ?, ?)").bind(u,p,y).run();let g=s.protocol==="https:",w=`Path=/; HttpOnly; SameSite=Lax; Max-Age=${720*60*60}${g?"; Secure":""}`;return new Response(JSON.stringify({success:!0,user:{id:p,email:r,name:d,avatar_url:null,provider:"email"}}),{status:201,headers:{"Content-Type":"application/json","Set-Cookie":`session=${u}; ${w}`}})}catch(t){return console.error("Registration error:",t),new Response(JSON.stringify({error:"\u767B\u9332\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}};export{f as onRequestPost};
