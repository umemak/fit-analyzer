function m(){return crypto.randomUUID()}function f(){let e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function S(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function E(e,t){if(!e)return null;let a=e.split(";");for(let i of a){let[r,c]=i.trim().split("=");if(r===t)return c}return null}var w=async e=>{let t=new URL(e.request.url),a=t.searchParams.get("code"),i=t.searchParams.get("state"),r=e.env.APP_URL||t.origin;if(!a){let s=S(),p=`${r}/api/auth/google`,n=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${e.env.GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(p)}&response_type=code&scope=openid%20email%20profile&access_type=offline&state=${s}`;return new Response(null,{status:302,headers:{Location:n,"Set-Cookie":`oauth_state=${s}; Path=/; HttpOnly; SameSite=Lax; Max-Age=600${t.protocol==="https:"?"; Secure":""}`}})}let c=E(e.request.headers.get("Cookie"),"oauth_state");if(!i||i!==c)return Response.redirect(`${r}/?error=invalid_state`,302);try{let s=`${r}/api/auth/google`,n=await(await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:e.env.GOOGLE_CLIENT_ID,client_secret:e.env.GOOGLE_CLIENT_SECRET,code:a,grant_type:"authorization_code",redirect_uri:s})})).json();if(n.error||!n.access_token)return Response.redirect(`${r}/?error=auth_failed`,302);let o=await(await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${n.access_token}`}})).json(),u=await e.env.DB.prepare("SELECT * FROM users WHERE provider = ? AND provider_id = ?").bind("google",o.id).first();if(!u){let g=m();await e.env.DB.prepare("INSERT INTO users (id, email, name, avatar_url, provider, provider_id) VALUES (?, ?, ?, ?, ?, ?)").bind(g,o.email,o.name,o.picture,"google",o.id).run(),u={id:g,email:o.email,name:o.name,avatar_url:o.picture}}let d=f(),h=new Date(Date.now()+720*60*60*1e3).toISOString();await e.env.DB.prepare("INSERT INTO sessions (id, user_id, expires_at) VALUES (?, ?, ?)").bind(d,u.id,h).run();let _=Response.redirect(`${r}/`,302),l=new Headers(_.headers);return l.set("Set-Cookie",`session=${d}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${720*60*60}${t.protocol==="https:"?"; Secure":""}`),new Response(null,{status:302,headers:l})}catch(s){return console.error("Google OAuth error:",s),Response.redirect(`${r}/?error=auth_failed`,302)}};export{w as onRequestGet};
