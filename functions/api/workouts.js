function u(e,r){if(!e)return null;let t=e.split(";");for(let s of t){let[a,o]=s.trim().split("=");if(a===r)return o}return null}async function i(e){let r=u(e.request.headers.get("Cookie"),"session");if(!r)return null;let t=await e.env.DB.prepare('SELECT user_id FROM sessions WHERE id = ? AND expires_at > datetime("now")').bind(r).first();return t?{id:t.user_id}:null}var l=async e=>{let r=await i(e);if(!r)return new Response(JSON.stringify({error:"\u8A8D\u8A3C\u304C\u5FC5\u8981\u3067\u3059"}),{status:401,headers:{"Content-Type":"application/json"}});try{let s=new URL(e.request.url).searchParams.get("id");if(s){let o=await e.env.DB.prepare("SELECT * FROM workouts WHERE id = ? AND user_id = ?").bind(s,r.id).first();if(!o)return new Response(JSON.stringify({error:"\u30EF\u30FC\u30AF\u30A2\u30A6\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"}),{status:404,headers:{"Content-Type":"application/json"}});let n=await e.env.DB.prepare("SELECT * FROM ai_analyses WHERE workout_id = ?").bind(s).first();return new Response(JSON.stringify({workout:{...o,workout_data:o.workout_data?JSON.parse(o.workout_data):null},aiAnalysis:n?{overallScore:n.overall_score,summary:n.summary,strengths:n.strengths?JSON.parse(n.strengths):[],improvements:n.improvements?JSON.parse(n.improvements):[],recommendations:n.recommendations?JSON.parse(n.recommendations):[],detailedAnalysis:n.detailed_analysis}:null}),{status:200,headers:{"Content-Type":"application/json"}})}let a=await e.env.DB.prepare(`SELECT w.id, w.file_name, w.sport, w.start_time, w.total_distance, w.total_time, 
              w.avg_heart_rate, w.avg_pace, w.total_calories, w.created_at,
              a.overall_score
       FROM workouts w
       LEFT JOIN ai_analyses a ON w.id = a.workout_id
       WHERE w.user_id = ?
       ORDER BY w.created_at DESC
       LIMIT 50`).bind(r.id).all();return new Response(JSON.stringify({workouts:a.results}),{status:200,headers:{"Content-Type":"application/json"}})}catch(t){return console.error("Workouts fetch error:",t),new Response(JSON.stringify({error:"\u30C7\u30FC\u30BF\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}},d=async e=>{let r=await i(e);if(!r)return new Response(JSON.stringify({error:"\u8A8D\u8A3C\u304C\u5FC5\u8981\u3067\u3059"}),{status:401,headers:{"Content-Type":"application/json"}});try{let s=new URL(e.request.url).searchParams.get("id");return s?(await e.env.DB.prepare("DELETE FROM workouts WHERE id = ? AND user_id = ?").bind(s,r.id).run(),new Response(JSON.stringify({success:!0}),{status:200,headers:{"Content-Type":"application/json"}})):new Response(JSON.stringify({error:"\u30EF\u30FC\u30AF\u30A2\u30A6\u30C8ID\u304C\u5FC5\u8981\u3067\u3059"}),{status:400,headers:{"Content-Type":"application/json"}})}catch(t){return console.error("Workout delete error:",t),new Response(JSON.stringify({error:"\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}};export{d as onRequestDelete,l as onRequestGet};
