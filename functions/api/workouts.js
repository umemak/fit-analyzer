function c(e,t){if(!e)return null;let s=e.split(";");for(let a of s){let[o,n]=a.trim().split("=");if(o===t)return n}return null}async function u(e){let t=c(e.request.headers.get("Cookie"),"session");if(!t)return null;let s=await e.env.DB.prepare('SELECT user_id FROM sessions WHERE id = ? AND expires_at > datetime("now")').bind(t).first();return s?{id:s.user_id}:null}var p=async e=>{let t=await u(e);if(!t)return new Response(JSON.stringify({error:"\u8A8D\u8A3C\u304C\u5FC5\u8981\u3067\u3059"}),{status:401,headers:{"Content-Type":"application/json"}});try{let a=new URL(e.request.url).searchParams.get("id");if(a){let n=await e.env.DB.prepare("SELECT * FROM workouts WHERE id = ? AND user_id = ?").bind(a,t.id).first();if(!n)return new Response(JSON.stringify({error:"\u30EF\u30FC\u30AF\u30A2\u30A6\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"}),{status:404,headers:{"Content-Type":"application/json"}});let i=null;if(n.r2_key)try{let l=await e.env.WORKOUT_DATA.get(n.r2_key);if(l){let d=await l.text();i=JSON.parse(d)}}catch(l){console.error("R2 fetch error:",l),n.workout_data&&(i=JSON.parse(n.workout_data))}else n.workout_data&&(i=JSON.parse(n.workout_data));let r=await e.env.DB.prepare("SELECT * FROM ai_analyses WHERE workout_id = ?").bind(a).first();return new Response(JSON.stringify({workout:{...n,workout_data:i},aiAnalysis:r?{overallScore:r.overall_score,performanceSummary:r.summary,strengths:r.strengths?JSON.parse(r.strengths):[],areasForImprovement:r.improvements?JSON.parse(r.improvements):[],trainingRecommendations:r.recommendations?JSON.parse(r.recommendations):[],heartRateAnalysis:r.detailed_analysis?JSON.parse(r.detailed_analysis).heartRateAnalysis:void 0,paceAnalysis:r.detailed_analysis?JSON.parse(r.detailed_analysis).paceAnalysis:void 0,recoveryAdvice:r.detailed_analysis?JSON.parse(r.detailed_analysis).recoveryAdvice:void 0}:null}),{status:200,headers:{"Content-Type":"application/json"}})}let o=await e.env.DB.prepare(`SELECT w.id, w.file_name, w.sport, w.start_time, w.total_distance, w.total_time, 
              w.avg_heart_rate, w.avg_pace, w.total_calories, w.created_at,
              a.overall_score
       FROM workouts w
       LEFT JOIN ai_analyses a ON w.id = a.workout_id
       WHERE w.user_id = ?
       ORDER BY w.created_at DESC
       LIMIT 50`).bind(t.id).all();return new Response(JSON.stringify({workouts:o.results}),{status:200,headers:{"Content-Type":"application/json"}})}catch(s){return console.error("Workouts fetch error:",s),new Response(JSON.stringify({error:"\u30C7\u30FC\u30BF\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}},_=async e=>{let t=await u(e);if(!t)return new Response(JSON.stringify({error:"\u8A8D\u8A3C\u304C\u5FC5\u8981\u3067\u3059"}),{status:401,headers:{"Content-Type":"application/json"}});try{let a=new URL(e.request.url).searchParams.get("id");if(!a)return new Response(JSON.stringify({error:"\u30EF\u30FC\u30AF\u30A2\u30A6\u30C8ID\u304C\u5FC5\u8981\u3067\u3059"}),{status:400,headers:{"Content-Type":"application/json"}});let o=await e.env.DB.prepare("SELECT r2_key FROM workouts WHERE id = ? AND user_id = ?").bind(a,t.id).first();if(o?.r2_key)try{await e.env.WORKOUT_DATA.delete(o.r2_key)}catch(n){console.error("R2 delete error:",n)}return await e.env.DB.prepare("DELETE FROM workouts WHERE id = ? AND user_id = ?").bind(a,t.id).run(),new Response(JSON.stringify({success:!0}),{status:200,headers:{"Content-Type":"application/json"}})}catch(s){return console.error("Workout delete error:",s),new Response(JSON.stringify({error:"\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F"}),{status:500,headers:{"Content-Type":"application/json"}})}};export{_ as onRequestDelete,p as onRequestGet};
